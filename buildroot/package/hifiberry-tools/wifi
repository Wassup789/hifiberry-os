#!/usr/bin/python

import sys
import fileinput
import re

def get_current_state(config_file):
    match_section_found = False
    with open(config_file, 'r') as file:
        for line in file:
            if '[Match]' in line:
                match_section_found = True
            elif match_section_found and re.match(r'Name=', line):
                if "wlan0" in line:
                    return "on"
                elif "donotconfigure" in line:
                    return "off"
                else:
                    return "unknown"  # Unknown configuration
    return "not configured"  # No [Match] section or Name= line found

def toggle_wifi_interface(state, config_file):
    match_section_found = False
    
    with fileinput.FileInput(config_file, inplace=True, backup='.bak') as file:
        for line in file:
            if '[Match]' in line:
                match_section_found = True
            elif match_section_found and re.match(r'Name=', line):
                if state == "on":
                    line = "Name=wlan0\n"
                elif state == "off":
                    line = "Name=donotconfigure\n"
                match_section_found = False  # Reset for potential multiple [Match] sections
            print(line, end='')

    if state:
        print(f"Interface set to {'wlan0' if state == 'on' else 'donotconfigure'}.")

if __name__ == "__main__":
    config_file = "/etc/systemd/network/wireless.network"

    if len(sys.argv) == 1:
        # No argument provided, display the current state
        current_state = get_current_state(config_file)
        print(f"Current interface configuration is: {current_state}")
    elif sys.argv[1] in ["on", "off"]:
        toggle_wifi_interface(sys.argv[1], config_file)
    else:
        print("Usage: script.py [on|off]")
        sys.exit(1)

